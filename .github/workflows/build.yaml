name: Build and Push Images

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'src/**'
  push:
    branches:
      - main
    paths:
      - 'src/**'

permissions:
  contents: read
  packages: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has-changes: ${{ steps.set-matrix.outputs.has-changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Detect changed images
        id: set-matrix
        run: |
          set -e
          
          # Determine comparison range based on event type
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "Detecting changes in PR (comparing against base branch)"
            git fetch origin ${{ github.base_ref }}
            CHANGED_DIRS=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '^src/' | cut -d'/' -f2 | sort -u || true)
          else
            echo "Detecting changes in push to main"
            # For first commit on branch, compare against empty tree
            if [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
              CHANGED_DIRS=$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }} | grep '^src/' | cut -d'/' -f2 | sort -u || true)
            else
              CHANGED_DIRS=$(git diff --name-only ${{ github.event.before }}..${{ github.sha }} | grep '^src/' | cut -d'/' -f2 | sort -u || true)
            fi
          fi
          
          # Debug output
          echo "Changed directories in src/:"
          echo "$CHANGED_DIRS"
          
          # Convert to JSON array
          if [ -z "$CHANGED_DIRS" ]; then
            echo "No changes detected in src/"
            echo "matrix=[]" >> $GITHUB_OUTPUT
            echo "has-changes=false" >> $GITHUB_OUTPUT
          else
            # Filter only directories that contain a Dockerfile
            VALID_DIRS=""
            for dir in $CHANGED_DIRS; do
              if [ -f "src/$dir/Dockerfile" ]; then
                VALID_DIRS="$VALID_DIRS $dir"
              else
                echo "Warning: src/$dir has changes but no Dockerfile found, skipping"
              fi
            done
            
            if [ -z "$VALID_DIRS" ]; then
              echo "No valid image directories with Dockerfile found"
              echo "matrix=[]" >> $GITHUB_OUTPUT
              echo "has-changes=false" >> $GITHUB_OUTPUT
            else
              # Convert to JSON array format
              MATRIX_JSON=$(echo "$VALID_DIRS" | tr ' ' '\n' | grep -v '^$' | jq -R -s -c 'split("\n") | map(select(length > 0))')
              echo "Matrix JSON: $MATRIX_JSON"
              echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
              echo "has-changes=true" >> $GITHUB_OUTPUT
            fi
          fi

  build-and-push:
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: docker/setup-buildx-action@v3
      
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/docker-custom-images/${{ matrix.image }}
          tags: |
            type=raw,value=pr-${{ github.event.pull_request.number }},enable=${{ github.event_name == 'pull_request' }}
            type=sha,prefix=sha-,format=short
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
      
      - uses: docker/build-push-action@v5
        with:
          context: ./src/${{ matrix.image }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.image }}
          cache-to: type=gha,mode=max,scope=${{ matrix.image }}
